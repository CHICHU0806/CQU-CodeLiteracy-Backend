<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>学习管理系统 - 个人主页</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            display: flex;
            height: 100vh;
            /* 老师为你换了一个稳定的学习氛围背景图，或者你可以直接用渐变色 */
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            /* 如果坚持用图片，试试下面这个： */
            /* background: url('https://images.unsplash.com/photo-1497633762265-9d179a990aa6?auto=format&fit=crop&w=1950&q=80') no-repeat center center fixed; */
            background-size: cover;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }

        /* 侧栏 */
        .sidebar {
            width: 220px; height: 100vh; position: fixed; z-index: 100;
            backdrop-filter: blur(10px); background: rgba(30, 30, 30, 0.8);
            border-right: 1px solid rgba(255, 255, 255, 0.1); color: white;
        }
        .sidebar-header { padding: 30px 15px; text-align: center; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
        .sidebar-header img { width: 65px; height: 65px; border-radius: 50%; border: 2px solid #F2876A; margin-bottom: 10px; }
        .sidebar-header h3 { color: #F2876A; font-size: 18px; }

        .sidebar-menu { padding: 15px 0; }
        .sidebar-item {
            padding: 15px 25px; cursor: pointer; transition: 0.3s;
            display: flex; align-items: center; gap: 12px; color: rgba(255, 255, 255, 0.7);
        }
        .sidebar-item:hover, .sidebar-item.active { background: rgba(242, 135, 106, 0.2); color: #F2876A; }
        .sidebar-item.active { border-left: 4px solid #F2876A; font-weight: bold; }

        /* 主区域 */
        .main-content { margin-left: 220px; flex: 1; background: rgba(255, 255, 255, 0.96); overflow-y: auto; }
        .content-header { height: 70px; background: white; padding: 0 30px; display: flex; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .container { padding: 30px; }

        /* 课程卡片 */
        .course-item {
            background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05); border-left: 5px solid #F2876A;
            display: flex; justify-content: space-between; align-items: center;
        }
        .course-link a { color: #F2876A; text-decoration: none; font-weight: bold; }

        /* 打卡面板 */
        .stat-card { background: #fff; padding: 25px; border-radius: 15px; box-shadow: 0 10px 20px rgba(0,0,0,0.05); text-align: center; margin-bottom: 25px;}
        .score-val { font-size: 36px; color: #F2876A; font-weight: bold; }
        #checkInBtnLarge {
            background: #F2876A; color: white; border: none; padding: 12px 30px;
            border-radius: 25px; font-size: 16px; cursor: pointer; transition: 0.3s;
        }
        #checkInBtnLarge:disabled { background: #ccc; cursor: not-allowed; }

        /* 响应式 */
        @media (max-width: 768px) {
            .sidebar { width: 70px; }
            .sidebar-header h3, .sidebar-item span { display: none; }
            .main-content { margin-left: 70px; }
        }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="sidebar-header">
        <img id="user-avatar" src="https://api.dicebear.com/7.x/avataaars/svg?seed=Lucky" alt="头像">
        <h3 id="display-username">加载中...</h3>
    </div>
    <div class="sidebar-menu">
        <div class="sidebar-item active" onclick="loadPage('home', this)"><i class="fas fa-home"></i> <span>首页</span></div>
        <div class="sidebar-item" onclick="loadPage('course', this)"><i class="fas fa-book"></i> <span>课程学习</span></div>
        <div class="sidebar-item" onclick="loadPage('study', this)"><i class="fas fa-calendar-alt"></i> <span>学习打卡</span></div>
        <div class="sidebar-item" onclick="window.location.href='login.html'"><i class="fas fa-sign-out-alt"></i> <span>退出登录</span></div>
    </div>
</div>

<div class="main-content">
    <div class="content-header"><h2 id="page-title">首页</h2></div>
    <div id="page-container" class="container">
    </div>
</div>

<script>
    const USERNAME = localStorage.getItem('username');
    const API_BASE = "http://localhost:8080/api";

    // 1. 初始化页面
    document.addEventListener('DOMContentLoaded', () => {
        if (!USERNAME) {
            alert("请先登录！");
            window.location.href = 'login.html';
            return;
        }
        document.getElementById('display-username').textContent = USERNAME;
        loadPage('home');
    });

    // 2. 页面切换逻辑
    function loadPage(page, element) {
        if (element) {
            document.querySelectorAll('.sidebar-item').forEach(i => i.classList.remove('active'));
            element.classList.add('active');
        }

        const container = document.getElementById('page-container');
        document.getElementById('page-title').textContent = {home:'首页', course:'课程学习', study:'学习打卡'}[page];

        if (page === 'home') {
            container.innerHTML = `
                <div class="stat-card">
                    <h3>你好，${USERNAME}！</h3>
                    <p>今天也是充满动力的一天，记得打卡哦。</p>
                    <button id="checkInBtnLarge" onclick="handleCheckIn()">立即签到</button>
                </div>
                <div id="calendarContainer"></div>
            `;
            refreshCheckInStatus();
            showCalendar();
        } else if (page === 'course') {
            renderCourses();
        } else if (page === 'study') {
            renderStudyStats();
        }
    }

    // 3. 签到逻辑 (统筹后)
    async function handleCheckIn() {
        try {
            const response = await fetch(`${API_BASE}/study/check-in`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: USERNAME })
            });
            const data = await response.json();

            if (data.success) {
                alert(data.message);
                // 关键：强制更新本地存储的角色状态或直接刷新界面数据
                await refreshCheckInStatus();
            } else {
                alert(data.message);
            }
        } catch (e) {
            alert("签到失败，请稍后再试");
        }
    }

    // 4. 获取并刷新分数状态
    async function refreshCheckInStatus() {
        if (!USERNAME) return;
        try {
            const res = await fetch(`${API_BASE}/study/score?username=${USERNAME}`);
            const data = await res.json();

            // 1. 更新按钮状态
            const btn = document.getElementById('checkInBtnLarge');
            if (data.isTodayChecked && btn) {
                btn.textContent = "今日已签到";
                btn.disabled = true;
                btn.style.background = "#ccc";
            }

            // 2. 更新“首页”显示的文字（如果有）
            // 3. 更新“打卡页”的分数
            const scoreVal = document.getElementById('totalScoresVal');
            const daysVal = document.getElementById('continuousDaysVal');

            if (scoreVal) scoreVal.innerText = data.totalScores;
            if (daysVal) daysVal.innerText = data.continuousDays;

        } catch (e) {
            console.error("刷新失败", e);
        }
    }

    // 5. 课程渲染
    // 5. 课程渲染 (对接你的后端 /api/courses/list 接口)
    async function renderCourses() {
        const container = document.getElementById('page-container');

        // 渲染页面骨架
        container.innerHTML = `
        <div class="stat-card" style="text-align: left; margin-bottom: 25px;">
            <h3 style="margin-bottom:10px;">加入新课程</h3>
            <div style="display: flex; gap: 10px;">
                <input type="text" id="courseIdInput" placeholder="输入课程ID加入 (如: database)"
                       style="flex:1; padding:12px; border:1px solid #ddd; border-radius:8px;">
                <button onclick="handleJoinCourse()"
                        style="background:#F2876A; color:white; border:none; padding:0 25px; border-radius:8px; cursor:pointer;">
                    确认加入
                </button>
            </div>
        </div>

        <h3 style="margin-bottom:15px;"><i class="fas fa-university"></i> 课程广场</h3>
        <div id="course-list-dynamic">正在从服务器同步课程数据...</div>
    `;

        try {
            // 注意：这里路径要和你后端的 @RequestMapping + @GetMapping 一致
            const response = await fetch(`${API_BASE}/courses/list`);
            const courses = await response.json();

            const listContainer = document.getElementById('course-list-dynamic');

            if (!courses || courses.length === 0) {
                listContainer.innerHTML = "<p>数据库里空空如也，请先在数据库添加几条课程记录吧。</p>";
                return;
            }

            let html = "";
            courses.forEach(c => {
                html += `
                <div class="course-item">
                    <div>
                        <h4 style="margin-bottom:5px;">${c.name}</h4>
                        <p style="font-size:13px; color:#666;">
                            讲师：${c.teacher || '待定'} | 编号: <span style="color:#F2876A;">${c.id}</span>
                        </p>
                    </div>
                    <div class="course-link">
                        <button onclick="handleJoinCourse('${c.id}')"
                                style="background:transparent; border:1px solid #F2876A; color:#F2876A; padding:6px 16px; border-radius:20px; cursor:pointer; font-weight:bold;">
                            加入课程
                        </button>
                    </div>
                </div>`;
            });
            listContainer.innerHTML = html;

        } catch (error) {
            console.error("加载失败:", error);
            document.getElementById('course-list-dynamic').innerHTML = "<p style='color:red;'>连接后端失败，请检查 Spring Boot 端口 8080 是否已启动。</p>";
        }
    }

    // 6. 打卡页统计渲染
    async function renderStudyStats() {
        document.getElementById('page-container').innerHTML = `
            <div class="stat-card">
                <p>总积分</p>
                <div class="score-val" id="totalScoresVal">...</div>
                <p style="margin-top:15px;">连续打卡天数</p>
                <div class="score-val" id="continuousDaysVal" style="color:#4ECDC4">...</div>
            </div>
        `;
        refreshCheckInStatus();
    }

    // 7. 日历组件 (增强版：自动标记签到)
    function showCalendar() {
        const container = document.getElementById('calendarContainer');
        if (!container) return;
        const now = new Date();
        const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();

        let html = `<div style="background:#fff; padding:20px; border-radius:15px; box-shadow:0 5px 15px rgba(0,0,0,0.05)">
            <h4 style="margin-bottom:15px;">${now.getFullYear()}年${now.getMonth()+1}月 签到月历</h4>
            <div style="display:grid; grid-template-columns: repeat(7, 1fr); gap:10px; text-align:center;">
        `;
        // 简易渲染 1 到 最后一天的方格
        for(let d=1; d<=daysInMonth; d++) {
            const isToday = d === now.getDate();
            // 注意：这里今日状态标记可以根据 refreshCheckInStatus 的结果来增强，目前简单处理
            const style = isToday ? "background:#F2876A; color:#fff; border-radius:50%;" : "border:1px solid #eee; border-radius:8px;";
            html += `<div style="padding:10px; ${style}">${d}</div>`;
        }
        html += `</div></div>`;
        container.innerHTML = html;
    }
</script>
</body>
</html>